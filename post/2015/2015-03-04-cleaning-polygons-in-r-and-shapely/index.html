<!DOCTYPE html> 
<html>
<head> 
		<title>Cleaning polygons in R and Shapely - Vacuum - Edward Vielmetti</title> 
	</head>
<body>


<h2>Vacuum weblog E. Vielmetti</h2>


<h3>
<a href="http://vielmetti.github.io/books/">books</a>
<a href="http://vielmetti.github.io/code/">code</a>
<a href="http://vielmetti.github.io/recipes/">recipes</a>
<a href="http://vielmetti.github.io/people/">people</a>
<a href="http://vielmetti.github.io/cities/">cities</a>
<a href="http://vielmetti.github.io/maps/">maps</a>
<a href="http://vielmetti.github.io/annarbor/">Ann Arbor</a>
<a href="http://vielmetti.github.io/categories/">categories</a>
<a href="http://vielmetti.github.io/keyphrases/">keyphrases</a>
</h3>




<h5>nature abhors a vacuum</h5>


<table>
<tr>
	

<td width="5%"></td>


<td width="30%" valign="top">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>Vacuum weblog from Edward Vielmetti</h1>
      <p class="lead">
       Tracking the comings and goings of @vielmetti 
      </p>
    </div>

    <h3><a href="http://vielmetti.github.io/">Home</a> </h3>
    <ul class="sidebar-nav">
      
        <li><a href="http://vielmetti.github.io/post/2015/2015-07-14-publishing-from-hugo-to-github-pages/"> Publishing from Hugo to Github Pages </a></li>
      
    </ul>

    <h3 class="panel-title">Recent Posts</h3> 
    <ul class="sidebar-recent">
	 
	<li><a href="http://vielmetti.github.io/post/2016/2016-03-30-upgrade-to-el-capitan/" class="list-group-item">Upgrade to El Capitan</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-02-14-stadium-boulevard-project/" class="list-group-item">Stadium Boulevard project bids high, portions of project to be delayed</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-02-14-chicken-and-onion-curry/" class="list-group-item">Chicken and onion curry</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-25-ann-arbor-public-schools-social-media-threat/" class="list-group-item">Ann Arbor Public Schools respond to social media threat</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-24-alaska-earthquake/" class="list-group-item">M7.1 earthquake felt in Anchorage, Alaska</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-22-writing-things-down/" class="list-group-item">Writing things down</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-22-a2b3-lunch-nonsummary/" class="list-group-item">a2b3 lunch non-summary for 3d week of January 2016</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-18-mlk-day-on-umich-campus/" class="list-group-item">Some highlights of MLK Day 2016 on the U of Michigan campus</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-17-qso-on-redditnet/" class="list-group-item">QSO on redditnet via Geekshed IRC</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-14-letterpress-qsl-cards/" class="list-group-item">Letterpress QSL cards</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-14-aprs-network-status/" class="list-group-item">Ann Arbor area APRS network status, January 2016</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-13-building-board-of-appeals-lacks-quorum-january-2016/" class="list-group-item">January 2016 Ann Arbor Building Board of Appeals lacks a quorum</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-13-dave-new-n8sbe-sdr-at-arrow/" class="list-group-item">Dave New N8SBE to speak at ARROW on Software Defined Radio</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-08-central-michigan-responds-to-morning-sun-wcmu-editorial/" class="list-group-item">Central Michigan University spokesman responds to Morning Sun editorial regarding WCMU-TV spectrum auction</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-08-a2council-liquor-license-report/" class="list-group-item">Ann Arbor City Council Liquor License Review Committee report, 8 January 2016</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-08-oxford-flood-network/" class="list-group-item">Oxford Flood Network</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-07-dexter-fire-inverness-condo/" class="list-group-item">Fire on Inverness in Dexter, Michigan</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-07-county-health-food-inspection-delays/" class="list-group-item">Washtenaw County Health Department delays food inspection reporting from November 2015</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-06-cuts-coming-to-mlive/" class="list-group-item">Cuts coming to MLive, 2016 edition; 29 content positions eliminated</a></li>
         
	<li><a href="http://vielmetti.github.io/post/2016/2016-01-06-wkar-television-spectrum-sale/" class="list-group-item">WKAR-TV television spectrum may be up for sale, and the station is at risk</a></li>
        
    </ul>

    <div class="sidebar-calendar">
	
    </div>

    <div class="sidebar-todo">
	
    </div>

    <div class="sidebar-blogroll">
	
    </div>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>

</td>


<td width="5%" valign="top"></td>


<td width="55%" valign="top" halign="right">
		<h3>4 March 2015</h3>
		<h1>Cleaning polygons in R and Shapely</h1> 
		<p>The project of the week has been an effort to generate a set of
maps - 2935 of them, in fact. The source data is from the Department
of Energy, listing a set of utility companies and the counties they
cover; the goal is to have a boundary map generated for each utility
company. I know it won&rsquo;t be a perfect boundary (most utility companies
have at least one county that they only provide service to part
of), but as a start it&rsquo;s a pretty good one.</p>

<p>The DOE data is based on their Form EIA-861, and I&rsquo;m working from
the 2013 data set. See <a
href="http://www.eia.gov/electricity/data/eia861/">Electric power
sales, revenue, and energy efficiency Form EIA-861 detailed data
files</a> if you want to get your own files. It&rsquo;s provided as Excel
(XLSX) files, so you&rsquo;ll need something compatible to read them; I
ended up using <a
href="http://csvkit.readthedocs.org/en/latest/scripts/in2csv.html">in2csv
from csvkit</a> as the first part of the pipeline to break these
apart.</p>

<p>You get lines from the provided file that look like this:</p>

<pre>
Data Year,Utility Number,Utility Name,State,County
2013,5109,DTE Electric Company,MI,Shiawassee
2013,5109,DTE Electric Company,MI,St Clair
2013,5109,DTE Electric Company,MI,Tuscola
2013,5109,DTE Electric Company,MI,Washtenaw
2013,5109,DTE Electric Company,MI,Wayne
</pre>

<p>The next challenge is to pull a map for each county served. To do this, convert the (State,County) list to a FIPS code, using a table like this one from ORNL called <a href="http://cta.ornl.gov/transnet/CoFIPS00.txt">CoFIPS00.txt</a>. (MI,Washtenaw) turns into 26161. Feed a list of FIPS codes into the Census Reporter geo API, and out comes GeoJSON files, like so: <a href="http://api.censusreporter.org/1.0/geo/show/tiger2013?geo_ids=05000US26103,05000US26003">GeoJSON for Marquette and Alger Counties, Michigan</a>. </p>

<p>We have a list of counties for each utility, so at minimum we're set right there. But we need to get 2935 of them, and it's kind of slow to wait for each one to return before fetching the next one. That motivates the use of <a href="http://www.gnu.org/software/parallel/">GNU Parallel</a>, a shell tool for executing jobs in parallel. On my four core MacBook Air I ran 32 jobs in parallel, and 2935 fetches (using "curl") took 287 seconds with the median elapsed time for each job at about 3 seconds - about a 31x speedup vs doing things serially.</p>

<p>However, the GeoJSON provided is really one shape per county, and we're looking for a complete service area in a single shape, so we need to merge the result together. Here a useful tool is the "R" stats package, particularly the "rgeos", "rgdal", and "maptools" packages. </p>

<p>The first step is the <a href="http://www.inside-r.org/packages/cran/rgdal/docs/ogrInfo">readOGR() function from the rgdal library</a>. It takes a variety of input map formats including GeoJSON and shape files and pulls them into a Spatial vector object in R. rgdal is an R interface to Frank Warmerdam's <a href="http://www.gdal.org/">Geospatial Data Abstraction Library</a>, and it handles both raster and vector geospatial data formats.</p>

<p>Next, use the <a href="http://www.inside-r.org/packages/cran/maptools/docs/unionSpatialPolygons">unionSpatialPolygons() function from the maptools library</a> to merge the county polygons into a single polygon. The docs say that this is a wrapper around the <a href="http://www.inside-r.org/packages/cran/rgeos/docs/gUnion">gUnion() function from the rgeos library</a>. rgeos comes from the Google Summer of Code 2010, and this <a href="https://gsoc2010r.wordpress.com/2010/06/10/rgeos-introduction/">introduction to the project</a> explains the motivation. rgeos provides an R interface to <a href="http://trac.osgeo.org/geos/">GEOS</a>, which is in turn a C++ port of <a href="http://tsusiatsoftware.net/jts/main.html">JTS</a>, the Java Topology Suite.</p>

<p>After you run the unionSpatialPolygons() operation, you will inevitably find that there are tiny holes in your unioned map. Geographic boundaries are complex, and as a result there are often little areas that don't quite touch, leaving little bits of land that aren't included anywhere. This algorithm from stackoverflow, <a href="http://stackoverflow.com/questions/12663263/dissolve-holes-in-polygon-in-r">Dissolve holes in polygon in R</a>, takes care of the issue. </p>

<pre>
G.rings = Filter(function(f){f@ringDir==1},G.union@polygons[[1]]@Polygons)
G.bounds = SpatialPolygons(list(Polygons(G.rings,ID=1)))
</pre>

<p>As the Polygon documentation note for ringDir: "the ring direction of the ring (polygon) coordinates, holes are expected to be anti-clockwise"</p>

<p>Having done this cleanup work, we return a GeoJSON file with the <a href="http://www.rdocumentation.org/packages/leafletR/functions/toGeoJSON">toGeoJSON() function from the leafletR package</a>. Now I probably don't need to pull in all of leafletR; there's a <a href="http://www.inside-r.org/packages/cran/rgdal/docs/writeOGR">writeOGR() function in the rgdal package</a> that should also do the same work. The aside, though, is that <a href="https://github.com/chgrl/leafletR">leafletR</a> creates nice maps in R using the <a href="http://leafletjs.com/">Leaflet</a> Javascript library.</p>

<p>With all that done, we have a new GeoJSON file that's a cleaned up merge of multiple county outlines done in R. However, the process isn't quite done. Some of the merged files don't have holes, but they do have "slivers", little angular bits of geometry from where two counties don't quite touch at their corners. I didn't find an algorithm to unsliver in R, but this <a href="http://gis.stackexchange.com/questions/120286/removing-small-polygons-gaps-in-a-shapely-polygon">Removing small polygons gaps in a Shapely polygon</a> did the trick. </p>

<pre>
# Here's the algorithm
fx = poly.buffer(eps, 1, join_style=JOIN_STYLE.mitre).buffer(-eps, 1, join_style=JOIN_STYLE.mitre)
</pre>

<p><a href="http://toblerity.org/shapely/manual.html">Shapely</a> from Sean Gilles is a "Python package for set-theoretic analysis and manipulation of planar features using (via Pythonâ€™s ctypes module) functions from the well known and widely deployed GEOS library." So we're back to GEOS, which is also supported by R...which means I suspect this algorithm translates directly back into R by proper invocation of the equivalent <a href="http://www.inside-r.org/packages/cran/rgeos/docs/gBuffer">gBuffer() function from the rgeos package</a>.</p>

<p>No matter, I installed Shapely. It's pretty fast, and if I had time to refine this operation I'd try to port all of the R code back into python using Shapely to see if I could get a meaningful speedup improvement.</p>

<p>All this description! Here's the code.</p>

<ul>
<li><a href="https://gist.github.com/vielmetti/13f6feae14111ff1c148">unsliver.py</a> - in Python with the Shapely library</li>
<li><a href="https://gist.github.com/450495defeff6e4d1440">mergeGeoJSON.Rscript</a> - in R with rgeos, sp, rgdal, maptools, and leafletR</li>
</ul>

<p>And here's a picture:</p>

<script src="https://gist.github.com/vielmetti/2a6feadf268ca2b686e7.js"></script>

<p>Thanks go to Joe Germuska (for Census Reporter and csvkit), Markus Spath (for R help), Matt Hampel (for mapping help), Jacob Wasserman (for Shapely help), Stan Gregg (for outage mapping), Mohan Kartha (for GNU Parallel and AWS help), and anyone else who I missed along the way.                                          </p>
 
</td>


<td width="5%" valign="top"></td>

</tr>
</table>


<h3>Notes afterwards</h3>
	<p>
	Recreating more or less my original layout, but with 
	dynamically loaded content. I guess that could work!
	</p>
	<p>
<a title="Real Time Analytics" href="http://clicky.com/100880293"><img alt="Real Time Analytics" src="//static.getclicky.com/media/links/badge.gif" border="0" /></a>
<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100880293); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100880293ns.gif" /></p></noscript>
</p>

</body>
</html> 
